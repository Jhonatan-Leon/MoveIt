<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Mapa interactivo Armenia</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        #map {
            width: 100%;
            height: 100vh;
        }

        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.85);
            padding: 10px;
            border-radius: 8px;
            font-family: Arial, sans-serif;
            z-index: 1000;
            box-shadow: 0 0 6px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
<div id="info">Haz clic en dos puntos para calcular la ruta</div>
<div id="map"></div>

<script>
    var map = L.map('map').setView([4.5339, -75.6811], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const apiKey = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjQ0ODYxMDdlMDFkOTRjOGE4NjE3NWY1NTUwZDhiMjk1IiwiaCI6Im11cm11cjY0In0=";

    let startMarker = null;
    let endMarker = null;
    let routeLine = null;

    map.on('click', function(e) {
        const { lat, lng } = e.latlng;

        if (!startMarker) {
            startMarker = L.marker([lat, lng]).addTo(map).bindPopup("Inicio").openPopup();
        } else if (!endMarker) {
            endMarker = L.marker([lat, lng]).addTo(map).bindPopup("Destino").openPopup();
            obtenerRuta();
        } else {
            // Reiniciar
            map.removeLayer(startMarker);
            map.removeLayer(endMarker);
            if (routeLine) map.removeLayer(routeLine);
            startMarker = L.marker([lat, lng]).addTo(map).bindPopup("Inicio").openPopup();
            endMarker = null;
            routeLine = null;
            document.getElementById("info").innerHTML = "Haz clic en dos puntos para calcular la ruta";
        }
    });

    function obtenerRuta() {
        const start = [startMarker.getLatLng().lng, startMarker.getLatLng().lat];
        const end = [endMarker.getLatLng().lng, endMarker.getLatLng().lat];

        fetch(`https://api.openrouteservice.org/v2/directions/driving-car?api_key=${apiKey}&start=${start.join(",")}&end=${end.join(",")}`)
            .then(res => res.json())
            .then(data => {
                const coords = data.features[0].geometry.coordinates;
                const route = coords.map(c => [c[1], c[0]]);
                routeLine = L.polyline(route, { color: 'blue', weight: 5 }).addTo(map);
                map.fitBounds(routeLine.getBounds());

                const summary = data.features[0].properties.summary;
                const distancia = (summary.distance / 1000).toFixed(2); // km
                const duracion = (summary.duration / 60).toFixed(1);    // min

                const inicioStr = `${startMarker.getLatLng().lat},${startMarker.getLatLng().lng}`;
                const finStr = `${endMarker.getLatLng().lat},${endMarker.getLatLng().lng}`;

                // Mostrar en el div
                document.getElementById("info").innerHTML = `
                    <b>Distancia:</b> ${distancia} km<br>
                    <b>Duraci√≥n:</b> ${duracion} min
                `;

                // Enviar a JavaFX si existe bridge
                if (window.java && typeof window.java.enviarRuta === "function") {
                    window.java.enviarRuta(inicioStr, finStr, distancia, duracion);
                }
            })
            .catch(err => {
                console.error("Error al obtener ruta:", err);
                document.getElementById("info").innerHTML = "Error al calcular la ruta.";
            });
    }
    function setStartPoint(lat, lng) {
        if (startMarker) map.removeLayer(startMarker);

        startMarker = L.marker([lat, lng]).addTo(map).bindPopup("Inicio").openPopup();
        map.setView([lat, lng], 15);
    }

    function setEndPoint(lat, lng) {
        if (endMarker) map.removeLayer(endMarker);

        endMarker = L.marker([lat, lng]).addTo(map).bindPopup("Destino").openPopup();
        map.setView([lat, lng], 15);

        if (startMarker) {
            obtenerRuta();
        }
    }

</script>
</body>
</html>
